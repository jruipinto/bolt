<div *ngIf="!assistenciaOpen">
  <span class="spinner spinner-inline">
  </span>
  <span>
    A carregar dados...
  </span>
</div>

<div *ngIf="assistenciaOpen as assistencia">
  <button type="button" class="btn btn-link btn-icon" style="margin:0; padding:0" (click)="navigateBack()">
    <clr-icon class="is-solid" size="36" shape="arrow" style="transform: rotate(270deg);"></clr-icon>
  </button>

  <h3>Assist√™ncia {{assistencia.id}}</h3>

  <div class="separate">
    <div class="clr-row">
      <div class="clr-col-md-2 fontheavy">
        Estado:
      </div>
      <div class="clr-col">
        {{assistencia.estado}}
      </div>
    </div>
  </div>
  <div class="separate">
    <div class="clr-row">
      <div class="clr-col-md-2 fontheavy">
        Cliente:
      </div>
      <div class="clr-col">
        {{assistencia.cliente_user_name}}
      </div>
    </div>
    <div class="clr-row">
      <div class="clr-col-md-2 fontheavy">
        T√©cnico:
      </div>
      <div class="clr-col">
        {{assistencia.registo_cronologico[assistencia.registo_cronologico.length-1].tecnico}}
      </div>
    </div>
    <div class="clr-row">
      <div class="clr-col-md-2 fontheavy">
        Equipamento:
      </div>
      <div class="clr-col">
        {{assistencia.categoria}}
        {{assistencia.marca}}
        {{assistencia.modelo}}
        {{assistencia.cor}}
      </div>
    </div>
    <div class="clr-row">
      <div class="clr-col-md-2 fontheavy">
        Serial:
      </div>
      <div class="clr-col">
        {{assistencia.serial}}
      </div>
    </div>
    <div class="clr-row">
      <div class="clr-col-md-2 fontheavy">
        Problema:
      </div>
      <div class="clr-col">
        {{assistencia.problema}}
      </div>
    </div>
  </div>
  <div class="separate">
    <div class="clr-row">
      <div class="clr-col">
        <div class="clr-row">
          <div class="clr-col">
            <button class="btn btn-link" (click)="modal = true">Adicionar material</button>
          </div>
        </div>
        <div class="clr-row" *ngIf="material">
          <div class="clr-col">
            <table class="table">
              <thead>
                <tr>
                  <th class="left">Qty</th>
                  <th>Descri√ß√£o</th>
                  <th>Local</th>
                  <th class="left">Custo p/ unidade</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let artigo of material">
                  <td class="left">{{artigo.qty}}</td>
                  <td>{{artigo.descricao}} {{artigo.marca}} {{artigo.modelo}}</td>
                  <td>{{artigo.localizacao}}</td>
                  <td class="left">{{artigo.preco | currency: 'EUR'}}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="separate">
    <div class="clr-row">
      <div class="clr-col-md-6">
        <div class="clr-row">
          <div class="clr-col fontheavy">
            Informa√ß√£o t√©cnica interna:
          </div>
        </div>
        <div class="clr-row">
          <div class="clr-col">
            <!--
            <textarea name="relatorio_interno" id="relatorio_interno" [attr.readonly]="assistencia.estado === 'contacto pendente'
                || assistencia.estado === 'n√£o atendeu p/ cont.'
                || assistencia.estado === 'cliente adiou resp.'
                || assistencia.estado === 'or√ßamento pendente'
                || assistencia.estado === 'n√£o atendeu p/ or√ß.'
                || assistencia.estado === 'cliente adiou or√ß.'
                || assistencia.estado === 'aguarda material'
                || assistencia.estado === 'conclu√≠do'
                || assistencia.estado === 'entregue'" [(ngModel)]='assistencia.relatorio_interno'></textarea>
              -->
            <textarea class="clr-textarea wd-100" name="relatorio_interno" id="relatorio_interno"
              [(ngModel)]='assistencia.relatorio_interno'></textarea>
          </div>
        </div>
      </div>
      <div class="clr-col-md-6">
        <div class="clr-row">
          <div class="clr-col fontheavy">
            Informa√ß√£o para o cliente:
          </div>
        </div>
        <div class="clr-row">
          <div class="clr-col">
            <textarea class="clr-textarea wd-100" name="relatorio_cliente" id="relatorio_cliente"
              [(ngModel)]='assistencia.relatorio_cliente'></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="separate">
    <div class="clr-row">
      <div class="clr-col-md-2 fontheavy">
        Or√ßamento:
      </div>
      <div class="clr-col">
        <span *ngIf="assistencia.orcamento">‚Ç¨ {{assistencia.orcamento}}</span>
        <span *ngIf="!assistencia.orcamento">n√£o tem</span>
      </div>
    </div>
    <div class="clr-row">
      <div class="clr-col-md-2 fontheavy">
        Pre√ßo:
      </div>
      <div class="clr-col-md-4">
        ‚Ç¨<input class="clr-input" type="number" name="preco" id="preco" [(ngModel)]='assistencia.preco'>
      </div>
    </div>
  </div>

  <div class="separate">

    <div *ngIf="assistencia.estado === 'recebido'
          || assistencia.estado === 'em an√°lise'
          || assistencia.estado === 'contactado'
          || assistencia.estado === 'incontact√°vel'
          || assistencia.estado === 'or√ßamento aprovado'
          || assistencia.estado === 'or√ßamento recusado'
          || assistencia.estado === 'material recebido'">
      <button class="btn btn-primary btn-icon" (click)="saveAssistencia('em an√°lise', assistencia)">
        <clr-icon class="is-solid" shape="floppy" flip="vertical"></clr-icon>
        Guardar
      </button>
      <clr-dropdown>
        <button clrDropdownTrigger class="btn btn-outline-primary">+ Op√ß√µes <clr-icon shape="caret down"></clr-icon>
        </button>
        <clr-dropdown-menu clrPosition="top-left" *clrIfOpen>
          <button clrDropdownItem (click)="saveAssistencia('or√ßamento pendente', assistencia)">Or√ßamentar
          </button>
          <button clrDropdownItem (click)="saveAssistencia('contacto pendente', assistencia)">Contactar
          </button>
          <button clrDropdownItem (click)="saveAssistencia('conclu√≠do', assistencia)">Concluir</button>
        </clr-dropdown-menu>
      </clr-dropdown>
    </div>

    <div *ngIf="assistencia.estado === 'or√ßamento pendente'
          || assistencia.estado === 'n√£o atendeu p/ or√ß.'
          || assistencia.estado === 'cliente adiou or√ß.'">
      <button class="btn btn-success" (click)="saveAssistencia('or√ßamento aprovado', assistencia)">Aceite</button>
      <clr-dropdown>
        <button clrDropdownTrigger class="btn btn-outline-primary">+ Op√ß√µes <clr-icon shape="caret down"></clr-icon>
        </button>
        <clr-dropdown-menu clrPosition="top-left" *clrIfOpen>
          <button clrDropdownItem (click)="saveAssistencia('or√ßamento recusado', assistencia)">Recusado
          </button>
          <button clrDropdownItem (click)="saveAssistencia('cliente adiou or√ß.', assistencia)">Cliente adiou
            resposta</button>
          <button clrDropdownItem (click)="saveAssistencia('n√£o atendeu p/ or√ß.', assistencia)">N√£o atendeu
          </button>
          <button clrDropdownItem (click)="saveAssistencia('incontact√°vel', assistencia)">Incontact√°vel
          </button>
        </clr-dropdown-menu>
      </clr-dropdown>
    </div>

    <div *ngIf="assistencia.estado === 'contacto pendente'
          || assistencia.estado === 'n√£o atendeu p/ cont.'
          || assistencia.estado === 'cliente adiou resp.'">
      <button type="button" class="btn btn-success" (click)="saveAssistencia('contactado', assistencia)">
        Sucesso
        <clr-icon shape="caret down"></clr-icon>
      </button>
      <clr-dropdown>
        <button clrDropdownTrigger class="btn btn-outline-primary">+ Op√ß√µes <clr-icon shape="caret down"></clr-icon>
        </button>
        <clr-dropdown-menu clrPosition="top-left" *clrIfOpen>
          <button type="button" (click)="saveAssistencia('contactado', assistencia)" clrDropdownItem>Cliente adiou
            resposta</button>
          <button type="button" (click)="saveAssistencia('n√£o atendeu p/ cont.', assistencia)" clrDropdownItem>N√£o
            atendeu</button>
          <button type="button" (click)="saveAssistencia('incontact√°vel', assistencia)"
            clrDropdownItem>Incontact√°vel</button>
        </clr-dropdown-menu>
      </clr-dropdown>
    </div>

    <div *ngIf="assistencia.estado === 'conclu√≠do'">
      <button class="btn btn-warning" (click)="saveAssistencia('entregue', assistencia)">
        Entregar
      </button>
    </div>

    <div *ngIf="assistencia.estado === 'entregue'">
      <button class="btn" (click)="openNewAssistenciaWithThisData(assistencia)">
        Receber Novamente
      </button>
    </div>
  </div>

</div>

<clr-modal [(clrModalOpen)]="modal" [clrModalSize]="'lg'">
  <h3 class="modal-title">Adicionar Material (üë∑ Em constru√ß√£o...)</h3>
  <div class="modal-body">
    <form [formGroup]="artigoSearchForm" (ngSubmit)="searchArtigo(artigoSearchForm.value.input)">
      <div class="clr-row">
        <div class="clr-col-12 padding-bottom-05">
          <input type="text" class="clr-input wd-100" placeholder="Digita algo..." name="input" formControlName="input" />
        </div>
      </div>
    </form>
    <h4>Resultados:</h4>
    <div *ngIf="results as artigos">
      <div *ngIf="artigos.length===0">ü§∑ N√£o encontrei nada... Tenta novamente com aten√ß√£o.</div>
      <div *ngIf="artigos.length>0">
        <r-data-row class="clr-row" *ngFor="let artigo of artigos; let listaIndex=index" (click)="addArtigo(artigo)">
          <div class="clr-col-lg-3">
            <span class="fontheavy">{{artigo.marca}}</span>
            {{artigo.modelo}}
          </div>
          <div class="clr-col-lg-6 lessimportant">
            {{artigo.descricao}}
          </div>
          <div class="clr-col-lg-1 lessimportant">
            Qty: {{artigo.qty}}
          </div>
          <div class="clr-col-lg-2 lessimportant">
            Local: {{artigo.localizacao}}
          </div>
        </r-data-row>
      </div>
    </div>
  </div>
</clr-modal>